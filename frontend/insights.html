<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Insights - Fiscal Pilot</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/animations.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="/dashboard.html" class="navbar-brand">ðŸš€ Fiscal Pilot</a>
                <ul class="navbar-nav">
                    <li><a href="/dashboard.html" class="navbar-link">Dashboard</a></li>
                    <li><a href="/expenses.html" class="navbar-link">Expenses</a></li>
                    <li><a href="/insights.html" class="navbar-link active">AI Insights</a></li>
                    <li><a href="/risk-profile.html" class="navbar-link">Risk Profile</a></li>
                    <li><a href="/education.html" class="navbar-link">Education</a></li>
                    <li><a href="/settings.html" class="navbar-link">Settings</a></li>
                </ul>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">ðŸŒ™</button>
                    <button onclick="window.app.logout()" class="btn btn-secondary">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Insights Content -->
    <section class="section">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1>AI Insights</h1>
                    <p class="text-muted">Transparent, explainable AI-driven financial analysis</p>
                </div>
                <button onclick="runAnalysis()" class="btn btn-primary" id="analyze-btn">Run Full Analysis</button>
            </div>

            <div id="alert-container"></div>

            <!-- Analysis Results -->
            <div id="analysis-results"></div>

            <!-- Previous Insights -->
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h2 class="card-title">Previous Insights</h2>
                </div>
                <div id="previous-insights">
                    <p class="text-center text-muted">Loading...</p>
                </div>
            </div>
        </div>
    </section>

    <script src="/js/theme.js"></script>
    <script src="/js/app.js"></script>
    <script>
        // Check authentication
        if (!window.app.isAuthenticated()) {
            window.location.href = '/login.html';
        }

        async function runAnalysis() {
            const btn = document.getElementById('analyze-btn');
            const container = document.getElementById('alert-container');
            const resultsContainer = document.getElementById('analysis-results');
            
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            resultsContainer.innerHTML = '<div class="card"><p class="text-center"><span class="loading"></span> Running AI analysis... This may take a moment.</p></div>';
            
            try {
                const result = await window.app.runFullAnalysis();
                displayAnalysisResults(result);
                window.app.showAlert('Analysis completed successfully!', 'success', container);
            } catch (error) {
                window.app.showAlert(error.message, 'danger', container);
                resultsContainer.innerHTML = '<div class="alert alert-danger">Analysis failed. Please try again.</div>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run Full Analysis';
                loadPreviousInsights();
            }
        }

        function displayAnalysisResults(result) {
            const container = document.getElementById('analysis-results');
            
            if (!result.success) {
                container.innerHTML = `<div class="alert alert-danger">Analysis encountered errors: ${result.errors.join(', ')}</div>`;
                return;
            }
            
            let html = '';
            
            // Risk Profile
            if (result.risk_profile) {
                const rp = result.risk_profile;
                const riskColor = rp.risk_level === 'Low' ? 'var(--accent-success)' : 
                                 rp.risk_level === 'Medium' ? 'var(--accent-warning)' : 
                                 'var(--accent-danger)';
                
                html += `
                    <div class="card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h2 class="card-title">Risk Profile</h2>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <h3 style="color: ${riskColor}; font-size: 2rem; margin: 0;">${rp.risk_level}</h3>
                                <p class="text-muted">Risk Level</p>
                            </div>
                            <div>
                                <h3 style="color: var(--accent-primary); font-size: 2rem; margin: 0;">${rp.risk_score}/100</h3>
                                <p class="text-muted">Risk Score</p>
                            </div>
                            <div>
                                <h3 style="font-size: 2rem; margin: 0;">${(rp.savings_rate || 0).toFixed(1)}%</h3>
                                <p class="text-muted">Savings Rate</p>
                            </div>
                            <div>
                                <h3 style="font-size: 2rem; margin: 0;">${(rp.emergency_fund_months || 0).toFixed(1)}</h3>
                                <p class="text-muted">Emergency Fund (months)</p>
                            </div>
                        </div>
                        ${rp.explanation ? `<p style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">${rp.explanation}</p>` : ''}
                    </div>
                `;
            }
            
            // Decision Recommendations
            if (result.decision && result.decision.recommendations) {
                html += `
                    <div class="card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h2 class="card-title">Investment Suitability</h2>
                        </div>
                        <div class="grid grid-3">
                            ${Object.entries(result.decision.recommendations).map(([asset, rec]) => {
                                const suitabilityColor = rec.suitability === 'suitable' ? 'var(--accent-success)' :
                                                        rec.suitability === 'moderately_suitable' ? 'var(--accent-warning)' :
                                                        'var(--accent-danger)';
                                return `
                                    <div class="card">
                                        <h3 style="text-transform: capitalize;">${asset}</h3>
                                        <p style="color: ${suitabilityColor}; font-weight: 600; margin: 0.5rem 0;">
                                            ${rec.suitability.replace('_', ' ')}
                                        </p>
                                        <p class="text-muted" style="font-size: 0.9rem;">${rec.reasoning}</p>
                                        ${rec.confidence_score ? `<small class="text-muted">Confidence: ${(rec.confidence_score * 100).toFixed(0)}%</small>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${result.decision.disclaimer ? `<div class="alert alert-info" style="margin-top: 1rem;">${result.decision.disclaimer}</div>` : ''}
                    </div>
                `;
            }
            
            // Explanation
            if (result.explanation) {
                const exp = result.explanation;
                html += `
                    <div class="card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h2 class="card-title">Explanation</h2>
                        </div>
                        <p>${exp.overall_explanation || 'Explanation will appear here after analysis.'}</p>
                        ${exp.transparency_notes ? `
                            <div style="margin-top: 1.5rem;">
                                <h4>Transparency Notes</h4>
                                <div style="margin-top: 1rem;">
                                    <h5>What We Know:</h5>
                                    <ul>
                                        ${(exp.transparency_notes.what_we_know || []).map(note => `<li>${note}</li>`).join('')}
                                    </ul>
                                    <h5 style="margin-top: 1rem;">Limitations:</h5>
                                    <ul>
                                        ${(exp.transparency_notes.limitations || []).map(lim => `<li>${lim}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        async function loadPreviousInsights() {
            const container = document.getElementById('previous-insights');
            
            try {
                const insights = await window.app.getInsights();
                
                if (insights.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">No previous insights. Run an analysis to get started.</p>';
                    return;
                }
                
                const list = document.createElement('div');
                insights.forEach(insight => {
                    const item = document.createElement('div');
                    item.style.padding = '1rem';
                    item.style.borderBottom = '1px solid var(--border-color)';
                    item.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4>${insight.decision_type}</h4>
                                <p class="text-muted" style="font-size: 0.9rem; margin: 0.5rem 0;">${insight.decision_summary}</p>
                                <small class="text-muted">${window.app.formatDate(insight.created_at)}</small>
                            </div>
                            ${insight.compliance_check_passed ? 
                                '<span class="badge badge-success">Compliant</span>' : 
                                '<span class="badge badge-danger">Non-Compliant</span>'}
                        </div>
                    `;
                    list.appendChild(item);
                });
                
                container.innerHTML = '';
                container.appendChild(list);
                
            } catch (error) {
                container.innerHTML = `<p class="text-center text-danger">Error loading insights: ${error.message}</p>`;
            }
        }

        // Load on page load
        loadPreviousInsights();
    </script>
</body>
</html>
